<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin WiFi Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; background: white; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #4f46e5; color: white; }
        .export-btn { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Panel de Administraci√≥n WiFi</h1>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Total Usuarios</h3>
                <p id="totalUsers">0</p>
            </div>
            <div class="stat-card">
                <h3>Hoy</h3>
                <p id="todayUsers">0</p>
            </div>
            <div class="stat-card">
                <h3>Con Redes Sociales</h3>
                <p id="socialUsers">0</p>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
            <div>
                <h2>Usuarios Registrados</h2>
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div>
                <h2>Exportar Datos</h2>
                <button class="export-btn" onclick="exportCSV()">üì• Exportar CSV</button>
                <button class="export-btn" onclick="exportJSON()">üì• Exportar JSON</button>
                
                <div style="margin-top: 30px;">
                    <canvas id="usersChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let usersData = [];
        
        async function loadUsers() {
            const response = await fetch('http://localhost:3001/api/users');
            usersData = await response.json();
            renderTable();
            updateStats();
            updateChart();
        }
        
        function renderTable() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = usersData.map(user => `
                <tr>
                    <td>${user.fullName}</td>
                    <td>${user.phone}</td>
                    <td>${user.email}</td>
                    <td>${new Date(user.accessDate).toLocaleString()}</td>
                    <td>
                        <button onclick="viewUser('${user._id}')">üëÅÔ∏è Ver</button>
                        <button onclick="deleteUser('${user._id}')">üóëÔ∏è Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateStats() {
            document.getElementById('totalUsers').textContent = usersData.length;
            const today = new Date().toDateString();
            const todayCount = usersData.filter(u => 
                new Date(u.accessDate).toDateString() === today
            ).length;
            document.getElementById('todayUsers').textContent = todayCount;
            
            const socialCount = usersData.filter(u => 
                u.facebook || u.instagram || u.twitter || u.linkedin
            ).length;
            document.getElementById('socialUsers').textContent = socialCount;
        }
        
        function updateChart() {
            const ctx = document.getElementById('usersChart').getContext('2d');
            const dates = {};
            
            usersData.forEach(user => {
                const date = new Date(user.accessDate).toLocaleDateString();
                dates[date] = (dates[date] || 0) + 1;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dates),
                    datasets: [{
                        label: 'Usuarios por d√≠a',
                        data: Object.values(dates),
                        backgroundColor: '#4f46e5'
                    }]
                }
            });
        }
        
        function exportCSV() {
            const headers = ['Nombre', 'Tel√©fono', 'Email', 'Facebook', 'Instagram', 'Twitter', 'LinkedIn', 'Fecha'];
            const rows = usersData.map(u => [
                u.fullName,
                u.phone,
                u.email,
                u.facebook || '',
                u.instagram || '',
                u.twitter || '',
                u.linkedin || '',
                new Date(u.accessDate).toLocaleString()
            ]);
            
            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            downloadFile('usuarios-wifi.csv', csv, 'text/csv');
        }
        
        function exportJSON() {
            downloadFile('usuarios-wifi.json', JSON.stringify(usersData, null, 2), 'application/json');
        }
        
        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function viewUser(id) {
            const response = await fetch(`http://localhost:3001/api/user/${id}`);
            const user = await response.json();
            alert(JSON.stringify(user, null, 2));
        }
        
        // Cargar datos al iniciar
        loadUsers();
        // Actualizar cada 30 segundos
        setInterval(loadUsers, 30000);
    </script>
</body>
</html>